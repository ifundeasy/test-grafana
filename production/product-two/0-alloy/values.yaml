replicaCount: 1

controller:
  type: deployment

image:
  repository: grafana/alloy
  tag: latest
  pullPolicy: IfNotPresent

alloy:
  resources:
    limits:
      cpu: 200m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 128Mi

  extraPorts:
    - name: grpc-otlp
      port: 4317
      targetPort: 4317
      protocol: TCP
    - name: http-otlp
      port: 4318
      targetPort: 4318
      protocol: TCP

  hostAliases:
    - ip: "10.140.0.104"
      hostnames:
        - "loki.local"
        - "tempo.local"
        - "mimir.local"

  configMap:
    create: true
    name: alloy-config
    content: |
      livedebugging {
        enabled = true
      }

      logging {
        level  = "info"
        format = "logfmt"
      }

      discovery.kubernetes "pods" {
        role = "pod"

        namespaces {
          names = ["product-two"]
        }
      }

      discovery.relabel "pod_relabel" {
        targets = discovery.kubernetes.pods.targets

        rule {
          source_labels = ["__meta_kubernetes_pod_controller_kind", "__meta_kubernetes_pod_controller_name"]
          separator     = "/"
          regex         = "ReplicaSet/(.+)"
          target_label  = "__tmp_replicaset_name"
          replacement   = "${1}"
        }
        
        rule {
          source_labels = ["__tmp_replicaset_name"]
          regex         = "(.+)-[a-z0-9]+"
          target_label  = "__tmp_deployment_name"
          replacement   = "${1}"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_controller_kind", "__meta_kubernetes_pod_controller_name"]
          separator     = "/"
          regex         = "Deployment/(.+)"
          target_label  = "__tmp_deployment_name"
          replacement   = "${1}"
        }


        rule {
          source_labels = ["__meta_kubernetes_pod_controller_kind", "__meta_kubernetes_pod_controller_name"]
          separator     = "/"
          regex         = "StatefulSet/(.+)"
          target_label  = "__tmp_deployment_name"
          replacement   = "${1}"
        }

        
        rule {
          source_labels = ["__meta_kubernetes_pod_controller_kind", "__meta_kubernetes_pod_controller_name"]
          separator     = "/"
          regex         = "DaemonSet/(.+)"
          target_label  = "__tmp_deployment_name"
          replacement   = "${1}"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_controller_kind", "__meta_kubernetes_pod_controller_name"]
          separator     = "/"
          regex         = "Job/(.+)"
          target_label  = "__tmp_deployment_name"
          replacement   = "${1}"
        }

        rule {
          source_labels = ["__meta_kubernetes_pod_controller_name"]
          target_label  = "__tmp_fallback_name"
        }

        rule {
          source_labels = ["__tmp_deployment_name", "__tmp_fallback_name"]
          separator     = ""
          regex         = "^$"
          replacement   = "${2}"
          target_label  = "__tmp_deployment_name"
        }

        rule {
          source_labels = ["__tmp_deployment_name"]
          target_label  = "service_name"
        }

        rule {
          source_labels = ["__tmp_deployment_name"]
          target_label  = "deployment_name"
        }
      }

      // ── LOGGING ─────────────────────────────────────────────
      loki.write "default" {
        endpoint {
          url     = "http://loki.local/loki/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "myorg-production-producttwo",
          }
        }
      }

      loki.source.kubernetes "pods" {
        targets = discovery.relabel.pod_relabel.output
        forward_to = [loki.write.default.receiver]
      }

      // ── TRACING ─────────────────────────────────────────────
      otelcol.receiver.otlp "traces" {
        grpc {
          endpoint = "0.0.0.0:4317"
        }

        http {
          endpoint = "0.0.0.0:4318"
        }

        output {
          traces = [
            otelcol.processor.attributes.traces.input,
            otelcol.connector.spanlogs.autologging.input,
          ]
          metrics = [
            otelcol.processor.attributes.traces.input,
          ]
        }
      }

      otelcol.connector.spanlogs "autologging" {
        spans = false
        roots = true
        processes = false
        span_attributes = [ "http.method", "http.target", "http.status_code" ]
        overrides {
            trace_id_key = "traceId"
        }

        output {
            logs = [otelcol.exporter.loki.autologging.input]
        }
      }

      otelcol.exporter.loki "autologging" {
          forward_to = [loki.process.autologging.receiver]
      }

      loki.process "autologging" {
        stage.json {
            expressions = { "body" = "" }
        }
        stage.output {
            source = "body"
        }
        forward_to = [loki.write.autologging.receiver]
      }

      loki.write "autologging" {
        external_labels = {
            job = "alloy",
        }

        endpoint {
            url = "http://loki.local/loki/api/v1/push"
            headers = {
                "X-Scope-OrgID" = "myorg-production-producttwo",
            }
        }
      }

      otelcol.processor.attributes "traces" {
        action {
          key    = "business-unit"
          value  = "product-two"
          action = "insert"
        }
        
        // Replace service.name with deployment name from Kubernetes metadata
        action {
          key    = "service.name"
          from_attribute = "k8s.deployment.name"
          action = "upsert"
        }

        output {
          traces = [otelcol.processor.batch.traces.input]
          metrics = [otelcol.processor.batch.traces.input]
        }
      }

      otelcol.exporter.otlp "traces" {
        client {
          endpoint = "tempo.local:8444"
          headers  = {
            "X-Scope-OrgID" = "myorg-production-producttwo",
          }

          tls {
            insecure = true
            insecure_skip_verify = true
          }
        }
      }

      otelcol.processor.batch "traces" {
        output {
          traces = [otelcol.exporter.otlp.traces.input]
          metrics = [otelcol.exporter.prometheus.tracemetrics.input]
        }
      }

      otelcol.exporter.prometheus "tracemetrics" {
        forward_to = [prometheus.remote_write.mimir.receiver]
      }

      // ── METRICS ────────────────────────────────────────────

      discovery.kubernetes "nodes" {
        role = "node"
      }

      // Relabeling untuk kubelet metrics (cAdvisor built-in)
      discovery.relabel "kubelet_cadvisor" {
        targets = discovery.kubernetes.nodes.targets
        
        rule {
          source_labels = ["__meta_kubernetes_node_name"]
          target_label  = "node"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_node_address_InternalIP"]
          target_label  = "__address__"
          replacement   = "${1}:10250"
        }
        
        rule {
          target_label = "__metrics_path__"
          replacement  = "/metrics/cadvisor"
        }
      }

      // Relabeling untuk kubelet metrics
      discovery.relabel "kubelet" {
        targets = discovery.kubernetes.nodes.targets
        
        rule {
          source_labels = ["__meta_kubernetes_node_name"]
          target_label  = "node"
        }
        
        rule {
          source_labels = ["__meta_kubernetes_node_address_InternalIP"]
          target_label  = "__address__"
          replacement   = "${1}:10250"
        }
        
        rule {
          target_label = "__metrics_path__"
          replacement  = "/metrics"
        }
      }

      // Scrape kubelet untuk node metrics
      prometheus.scrape "kubelet" {
        targets = discovery.relabel.kubelet.output
        
        scrape_interval = "30s"
        scrape_timeout  = "15s"
        scheme         = "https"
        
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        
        tls_config {
          ca_file              = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          insecure_skip_verify = true
        }
        
        forward_to = [prometheus.remote_write.mimir.receiver]
      }

      // Scrape cAdvisor untuk container/pod metrics
      prometheus.scrape "cadvisor" {
        targets = discovery.relabel.kubelet_cadvisor.output
        
        scrape_interval = "30s"
        scrape_timeout  = "15s"
        scheme         = "https"
        
        bearer_token_file = "/var/run/secrets/kubernetes.io/serviceaccount/token"
        
        tls_config {
          ca_file              = "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
          insecure_skip_verify = true
        }
        
        forward_to = [prometheus.remote_write.mimir.receiver]
      }

      prometheus.remote_write "mimir" {
        endpoint {
          url = "http://mimir.local/api/v1/push"
          headers = {
            "X-Scope-OrgID" = "myorg-production-producttwo",
          }
          queue_config {
            capacity          = 10000
            max_shards        = 200
            min_shards        = 1
            max_samples_per_send = 5000
            batch_send_deadline = "5s"
          }
        }
      }
